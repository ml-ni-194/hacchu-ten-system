<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .setting-group input,
        .setting-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-card .label {
            color: #666;
            font-size: 14px;
        }

        .summary-card.alert {
            border-left: 4px solid #e74c3c;
        }

        .summary-card.warning {
            border-left: 4px solid #f39c12;
        }

        .summary-card.success {
            border-left: 4px solid #27ae60;
        }

        .summary-card.info {
            border-left: 4px solid #3498db;
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« */
        .data-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-normal {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .status-ordered {
            background: #cce5ff;
            color: #0056b3;
        }

        /* æ•°å€¤ã‚«ãƒ©ãƒ¼ */
        .number-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .number-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .number-neutral {
            color: #333;
        }

        /* å•†å“ã‚³ãƒ¼ãƒ‰è¡¨ç¤º */
        .product-code {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #666;
            margin-right: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .product-code:hover {
            background: #e0e0e0;
        }

        .product-name-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .product-name {
            flex: 1;
            min-width: 200px;
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .copy-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box {
                width: 100%;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¿ãƒ– */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upload-group label {
            font-weight: bold;
            color: #2c3e50;
        }

        .upload-group input[type="file"] {
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-group input[type="file"]:hover {
            border-color: #3498db;
        }

        .upload-group small {
            color: #666;
            font-size: 12px;
        }

        .upload-status {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .status-uploaded {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .current-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .current-settings h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .csv-format-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .csv-format-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .csv-format-info li {
            margin: 5px 0;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }

        /* é¸æŠæ©Ÿèƒ½ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-controls {
            display: flex;
            gap: 10px;
        }

        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .selected-count {
            color: #3498db;
            font-weight: bold;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .action-column {
            width: 80px;
            text-align: center;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        /* ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ  */
        .order-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group-inline {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .form-group-inline label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .form-group-inline input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .upload-status {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            max-width: 500px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            margin: 0;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: white;
            z-index: 1001;
        }

        .close:hover {
            opacity: 0.7;
        }

        /* è¨­å®šã‚¿ãƒ– */
        .settings-tab-container {
            padding: 0 20px;
        }

        .settings-tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .settings-tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .settings-tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .settings-tab-content {
            display: none;
            padding: 0 20px;
        }

        .settings-tab-content.active {
            display: block;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .settings-form .setting-group {
            display: flex;
            flex-direction: column;
        }

        .settings-form .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .settings-form .setting-group input,
        .settings-form .setting-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .settings-form .setting-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .settings-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .settings-tab-buttons {
                flex-wrap: wrap;
            }
            
            .settings-tab-button {
                flex: 1;
                min-width: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">ğŸ“Š åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
            <div class="user-info">
                <span id="lastUpdate">æœ€çµ‚æ›´æ–°: --:--</span>
                <button class="btn" onclick="refreshData()">ğŸ”„ æ›´æ–°</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« -->
        <div class="settings-panel">
            <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div class="upload-section">
                <div class="upload-group">
                    <label for="inventoryFile">ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿CSV</label>
                    <input type="file" id="inventoryFile" accept=".csv" onchange="handleInventoryFile(event)">
                    <small>ã‚¹ãƒãƒ¬ã‚¸ã®å•†å“ãƒ‡ãƒ¼ã‚¿CSVãƒ•ã‚¡ã‚¤ãƒ« (å•†å“ãƒ‡ãƒ¼ã‚¿20250707150911.csvå½¢å¼)</small>
                </div>
                <div class="upload-group">
                    <label for="salesFile">ğŸ“Š åœ¨åº«å±¥æ­´é›†è¨ˆCSV</label>
                    <input type="file" id="salesFile" accept=".csv" onchange="handleSalesFile(event)">
                    <small>ã‚¹ãƒãƒ¬ã‚¸ã®åœ¨åº«å±¥æ­´é›†è¨ˆCSVãƒ•ã‚¡ã‚¤ãƒ« (åœ¨åº«å±¥æ­´é›†è¨ˆ20250707153725.csvå½¢å¼)</small>
                </div>
            </div>
            <div class="upload-status">
                <div class="status-item">
                    <span>å•†å“ãƒ‡ãƒ¼ã‚¿:</span>
                    <span id="inventoryStatus" class="status-badge status-normal">æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </div>
                <div class="status-item">
                    <span>åœ¨åº«å±¥æ­´é›†è¨ˆ:</span>
                    <span id="salesStatus" class="status-badge status-normal">æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </div>
            </div>
            <div class="current-settings">
                <h4>âš™ï¸ ç¾åœ¨ã®è¨­å®š</h4>
                <div style="font-size: 14px; color: #666; line-height: 1.4;">
                    <span id="currentSettings">åˆ†ææœŸé–“: 2é€±é–“ | ç™ºæ³¨ç‚¹: æ—¥å¹³å‡å‡ºè·æ•° Ã— 37æ—¥</span>
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                    <span id="lastCalculation">æœ€çµ‚è¨ˆç®—: æœªå®Ÿè¡Œ</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="showSettings()">âš™ï¸ è¨­å®š</button>
                <button class="btn btn-success" onclick="calculateReorderPoints()" id="calculateBtn" disabled>ğŸ“Š ç™ºæ³¨ç‚¹ã‚’è¨ˆç®—</button>
                <button class="btn" onclick="downloadSampleCSV()">ğŸ“¥ ã‚¹ãƒãƒ¬ã‚¸CSVå½¢å¼ã‚µãƒ³ãƒ—ãƒ«</button>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="summary-grid">
            <div class="summary-card alert">
                <div class="number" id="urgentCount">0</div>
                <div class="label">ç·Šæ€¥ç™ºæ³¨å¿…è¦</div>
            </div>
            <div class="summary-card warning">
                <div class="number" id="warningCount">0</div>
                <div class="label">ç™ºæ³¨æ¨å¥¨</div>
            </div>
            <div class="summary-card info">
                <div class="number" id="orderedCount">0</div>
                <div class="label">ç™ºæ³¨ä¸­</div>
            </div>
            <div class="summary-card success">
                <div class="number" id="normalCount">0</div>
                <div class="label">åœ¨åº«æ­£å¸¸</div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒãƒ« -->
        <div class="data-panel">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('reorder')">ğŸš¨ ç™ºæ³¨å¿…è¦</button>
                    <button class="tab-button" onclick="showTab('ordered')">ğŸ“‹ ç™ºæ³¨ä¸­</button>
                    <button class="tab-button" onclick="showTab('all')">ğŸ“Š å…¨å•†å“</button>
                </div>
            </div>

            <div class="panel-header">
                <h3 class="panel-title" id="currentTabTitle">ç™ºæ³¨ãŒå¿…è¦ãªå•†å“</h3>
                <div class="filter-controls">
                    <input type="text" class="search-box" placeholder="å•†å“åã§æ¤œç´¢..." onkeyup="filterTable()">
                    <select onchange="filterByCategory()" id="categoryFilter">
                        <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
                    </select>
                </div>
            </div>

            <!-- ç™ºæ³¨å¿…è¦ã‚¿ãƒ– -->
            <div id="reorder-tab" class="tab-content active">
                <div class="table-controls">
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" id="selectAllReorder" onchange="toggleSelectAllReorder()">
                            å…¨é¸æŠ
                        </label>
                        <span class="selected-count" id="reorderSelectedCount">0ä»¶é¸æŠ</span>
                    </div>
                    <div class="action-controls">
                        <button class="btn btn-success btn-sm" onclick="moveSelectedToOrdered()" id="moveToOrderedBtn" disabled>é¸æŠå•†å“ã‚’ç™ºæ³¨ä¸­ã«ç§»å‹•</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">é¸æŠ</th>
                            <th>å•†å“å</th>
                            <th>ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>ç¾åœ¨åœ¨åº«</th>
                            <th>ç™ºæ³¨ç‚¹</th>
                            <th>ä¸è¶³æ•°</th>
                            <th>æ—¥å¹³å‡è²©å£²</th>
                            <th>å„ªå…ˆåº¦</th>
                            <th class="action-column">å€‹åˆ¥æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="reorderTableBody">
                        <tr>
                            <td colspan="9" class="loading">
                                <div class="loading-spinner"></div>
                                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ç™ºæ³¨ä¸­ã‚¿ãƒ– -->
            <div id="ordered-tab" class="tab-content">
                <div class="table-controls">
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" id="selectAllOrdered" onchange="toggleSelectAllOrdered()">
                            å…¨é¸æŠ
                        </label>
                        <span class="selected-count" id="orderedSelectedCount">0ä»¶é¸æŠ</span>
                    </div>
                    <div class="action-controls">
                        <button class="btn btn-success btn-sm" onclick="completeSelectedOrders()" id="completeOrdersBtn" disabled>é¸æŠå•†å“ã‚’å…¥è·å®Œäº†</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedOrders()" id="deleteOrdersBtn" disabled>é¸æŠå•†å“ã‚’å‰Šé™¤</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">é¸æŠ</th>
                            <th>å•†å“å</th>
                            <th>ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>ç¾åœ¨åœ¨åº«</th>
                            <th>ç™ºæ³¨æ•°</th>
                            <th>ç™ºæ³¨æ—¥</th>
                            <th>äºˆå®šç´æœŸ</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th class="action-column">å€‹åˆ¥æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="orderedTableBody">
                        <tr>
                            <td colspan="9" class="loading">ç™ºæ³¨ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- å…¨å•†å“ã‚¿ãƒ– -->
            <div id="all-tab" class="tab-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å•†å“å</th>
                            <th>ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>ç¾åœ¨åœ¨åº«</th>
                            <th>ç™ºæ³¨ç‚¹</th>
                            <th>æ—¥å¹³å‡è²©å£²</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th class="action-column">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="allTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="loading-spinner"></div>
                                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2>ğŸ“‹ ç™ºæ³¨æƒ…å ±å…¥åŠ›</h2>
            <div id="orderItemsList"></div>
            <div class="order-form">
                <div class="form-row">
                    <div class="form-group-inline">
                        <label for="orderQuantity">ç™ºæ³¨æ•°</label>
                        <input type="number" id="orderQuantity" min="1" placeholder="ç™ºæ³¨æ•°ã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group-inline">
                        <label for="expectedDelivery">äºˆå®šç´æœŸ</label>
                        <input type="date" id="expectedDelivery">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group-inline">
                        <label for="orderMemo">ãƒ¡ãƒ¢</label>
                        <input type="text" id="orderMemo" placeholder="ç™ºæ³¨ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢">
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn" onclick="closeOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-success" onclick="confirmOrder()">ç™ºæ³¨ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
            
            <!-- è¨­å®šã‚¿ãƒ– -->
            <div class="settings-tab-container">
                <div class="settings-tab-buttons">
                    <button class="settings-tab-button active" onclick="showSettingsTab('calculation')">ğŸ“Š è¨ˆç®—è¨­å®š</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('api')">ğŸ“ CSVè¨­å®š</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('notification')">ğŸ”” é€šçŸ¥è¨­å®š</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('display')">ğŸ–¥ï¸ è¡¨ç¤ºè¨­å®š</button>
                </div>
            </div>

            <!-- è¨ˆç®—è¨­å®šã‚¿ãƒ– -->
            <div id="calculation-settings" class="settings-tab-content active">
                <h3>ğŸ“Š ç™ºæ³¨ç‚¹è¨ˆç®—è¨­å®š</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="analysisWeeks">åˆ†ææœŸé–“</label>
                        <select id="analysisWeeks">
                            <option value="1">1é€±é–“</option>
                            <option value="2" selected>2é€±é–“</option>
                            <option value="3">3é€±é–“</option>
                            <option value="4">4é€±é–“</option>
                        </select>
                        <small>å‡ºè·ãƒ‡ãƒ¼ã‚¿ã®åˆ†ææœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>ç™ºæ³¨ç‚¹è¨ˆç®—æ–¹æ³•</label>
                        <div class="csv-format-info">
                            <p><strong>è¨ˆç®—å¼:</strong></p>
                            <p>æ—¥å¹³å‡å‡ºè·æ•° = åˆ†ææœŸé–“ã®å‡ºè·æ•° Ã· åˆ†ææ—¥æ•°</p>
                            <p>ç™ºæ³¨ç‚¹ = æ—¥å¹³å‡å‡ºè·æ•° Ã— 37æ—¥</p>
                            <p>ç™ºæ³¨åˆ¤å®š = ç¾åœ¨åœ¨åº« < ç™ºæ³¨ç‚¹</p>
                        </div>
                        <small>37æ—¥ã¯å›ºå®šå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="urgentThreshold">ç·Šæ€¥ç™ºæ³¨ã—ãã„å€¤</label>
                        <input type="number" id="urgentThreshold" value="50" min="0" max="100">
                        <small>ç™ºæ³¨ç‚¹ã‹ã‚‰ä½•%ä¸‹å›ã£ãŸã‚‰ç·Šæ€¥ã¨ã™ã‚‹ã‹</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="autoCalculate">è‡ªå‹•è¨ˆç®—</label>
                        <select id="autoCalculate">
                            <option value="manual">æ‰‹å‹•ã®ã¿</option>
                            <option value="hourly">1æ™‚é–“ã”ã¨</option>
                            <option value="daily">1æ—¥1å›</option>
                            <option value="weekly">é€±1å›</option>
                        </select>
                        <small>ç™ºæ³¨ç‚¹ã®è‡ªå‹•å†è¨ˆç®—é »åº¦</small>
                    </div>
                </div>
            </div>

            <!-- APIè¨­å®šã‚¿ãƒ– -->
            <div id="api-settings" class="settings-tab-content">
                <h3>ğŸ“ ã‚¹ãƒãƒ¬ã‚¸CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label>å•†å“ãƒ‡ãƒ¼ã‚¿CSVã®å½¢å¼</label>
                        <div class="csv-format-info">
                            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«åä¾‹:</strong> å•†å“ãƒ‡ãƒ¼ã‚¿20250707150911.csv</p>
                            <p><strong>ä½¿ç”¨ã™ã‚‹åˆ—:</strong></p>
                            <ul>
                                <li>Cåˆ—: å•†å“ã‚³ãƒ¼ãƒ‰ (ä¾‹: P001, 156&145)</li>
                                <li>Dåˆ—: éƒ¨é–€å (ä¾‹: è‡ªå‹•è»Šéƒ¨å“)</li>
                                <li>Fåˆ—: å•†å“å (ä¾‹: P7 ãƒ‘ãƒ¼ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼50mm)</li>
                                <li>Påˆ—: åœ¨åº«æ•° (ä¾‹: 5, 0)</li>
                            </ul>
                            <p><small>â€»ã‚¹ãƒãƒ¬ã‚¸ç®¡ç†ç”»é¢ã®ã€Œå•†å“ã€â†’ã€Œå•†å“ä¸€è¦§ã€ã‹ã‚‰CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</small></p>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label>åœ¨åº«å±¥æ­´é›†è¨ˆCSVã®å½¢å¼</label>
                        <div class="csv-format-info">
                            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«åä¾‹:</strong> åœ¨åº«å±¥æ­´é›†è¨ˆ20250707153725.csv</p>
                            <p><strong>ä½¿ç”¨ã™ã‚‹åˆ—:</strong></p>
                            <ul>
                                <li>Cåˆ—: å•†å“ã‚³ãƒ¼ãƒ‰ (ä¾‹: P001, 156&145)</li>
                                <li>Kåˆ—: è²©å£²æ•°é‡ (ä¾‹: 5, 10)</li>
                            </ul>
                            <p><small>â€»ã‚¹ãƒãƒ¬ã‚¸ç®¡ç†ç”»é¢ã®ã€Œåœ¨åº«ã€â†’ã€Œåœ¨åº«å±¥æ­´é›†è¨ˆã€ã‹ã‚‰CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</small></p>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="csvEncoding">CSVã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</label>
                        <select id="csvEncoding">
                            <option value="shift_jis" selected>Shift-JIS (ã‚¹ãƒãƒ¬ã‚¸æ¨™æº–)</option>
                            <option value="utf-8">UTF-8</option>
                            <option value="utf-8-bom">UTF-8 with BOM</option>
                        </select>
                        <small>ã‚¹ãƒãƒ¬ã‚¸ã®CSVã¯é€šå¸¸Shift-JISã§ã™</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="csvDelimiter">åŒºåˆ‡ã‚Šæ–‡å­—</label>
                        <select id="csvDelimiter">
                            <option value="," selected>ã‚«ãƒ³ãƒ (,)</option>
                            <option value="\t">ã‚¿ãƒ–</option>
                            <option value=";">ã‚»ãƒŸã‚³ãƒ­ãƒ³ (;)</option>
                        </select>
                        <small>CSVãƒ•ã‚¡ã‚¤ãƒ«ã®åŒºåˆ‡ã‚Šæ–‡å­—</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="validateData" checked> ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</label>
                            <label><input type="checkbox" id="skipEmptyRows" checked> ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—</label>
                            <label><input type="checkbox" id="autoCorrectData"> è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ä¿®æ­£</label>
                        </div>
                        <small>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="googleScriptUrl">Google Apps Script URL</label>
                        <input type="url" id="googleScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <small>Google Apps Scriptã®Webã‚¢ãƒ—ãƒªURL</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>ãƒ‡ãƒ¼ã‚¿åŒæœŸ</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="syncFromSpreadsheet()">ğŸ“¥ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—</button>
                            <button class="btn" onclick="syncToSpreadsheet()">ğŸ“¤ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜</button>
                        </div>
                        <small>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸ</small>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥è¨­å®šã‚¿ãƒ– -->
            <div id="notification-settings" class="settings-tab-content">
                <h3>ğŸ”” é€šçŸ¥è¨­å®š</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="emailNotification">ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</label>
                        <select id="emailNotification">
                            <option value="disabled">ç„¡åŠ¹</option>
                            <option value="urgent">ç·Šæ€¥æ™‚ã®ã¿</option>
                            <option value="daily">æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</option>
                            <option value="weekly">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</option>
                        </select>
                        <small>ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®é »åº¦ã‚’é¸æŠ</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="emailAddress">é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="emailAddress" placeholder="notification@company.com">
                        <small>è¤‡æ•°ã®å ´åˆã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‹</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="slackNotification">Slacké€šçŸ¥</label>
                        <select id="slackNotification">
                            <option value="disabled">ç„¡åŠ¹</option>
                            <option value="urgent">ç·Šæ€¥æ™‚ã®ã¿</option>
                            <option value="all">å…¨ã¦</option>
                        </select>
                        <small>Slacké€šçŸ¥ã®è¨­å®š</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="slackWebhook">Slack Webhook URL</label>
                        <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                        <small>Slackã®Incoming Webhook URL</small>
                    </div>
                </div>
            </div>

            <!-- è¡¨ç¤ºè¨­å®šã‚¿ãƒ– -->
            <div id="display-settings" class="settings-tab-content">
                <h3>ğŸ–¥ï¸ è¡¨ç¤ºè¨­å®š</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="itemsPerPage">1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°</label>
                        <select id="itemsPerPage">
                            <option value="10">10ä»¶</option>
                            <option value="25" selected>25ä»¶</option>
                            <option value="50">50ä»¶</option>
                            <option value="100">100ä»¶</option>
                        </select>
                        <small>ãƒ†ãƒ¼ãƒ–ãƒ«ã®1ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹å•†å“æ•°</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="theme">ãƒ†ãƒ¼ãƒ</label>
                        <select id="theme">
                            <option value="light" selected>ãƒ©ã‚¤ãƒˆ</option>
                            <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
                            <option value="auto">è‡ªå‹•</option>
                        </select>
                        <small>ç”»é¢ã®é…è‰²ãƒ†ãƒ¼ãƒ</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="refreshInterval">ç”»é¢æ›´æ–°é–“éš”</label>
                        <select id="refreshInterval">
                            <option value="manual">æ‰‹å‹•ã®ã¿</option>
                            <option value="300">5åˆ†</option>
                            <option value="900">15åˆ†</option>
                            <option value="1800">30åˆ†</option>
                            <option value="3600">1æ™‚é–“</option>
                        </select>
                        <small>ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ›´æ–°é–“éš”</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="compactMode">ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</label>
                        <select id="compactMode">
                            <option value="false" selected>é€šå¸¸</option>
                            <option value="true">ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ</option>
                        </select>
                        <small>ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œé–“ã‚’è©°ã‚ã¦è¡¨ç¤º</small>
                    </div>
                </div>
            </div>

            <!-- è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ -->
            <div class="settings-footer">
                <button class="btn" onclick="resetSettings()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                <button class="btn btn-success" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ã‚³ãƒ”ãƒ¼é€šçŸ¥ -->
    <div id="copyNotification" class="copy-notification">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let inventoryData = [];
        let orderedItems = [];
        let currentTab = 'reorder';
        let uploadedInventoryData = null;
        let uploadedSalesData = null;
        let selectedReorderItems = new Set();
        let selectedOrderedItems = new Set();
        let itemsToOrder = [];
        let GOOGLE_SCRIPT_URL = ''; // Google Apps Scriptã®Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®š
        let currentSettings = {
            analysisWeeks: 2,
            leadTime: 7,
            safetyStock: 3,
            urgentThreshold: 50,
            autoCalculate: 'manual',
            csvEncoding: 'shift_jis',
            csvDelimiter: ',',
            validateData: true,
            skipEmptyRows: true,
            autoCorrectData: false,
            googleScriptUrl: '',
            emailNotification: 'disabled',
            emailAddress: '',
            slackNotification: 'disabled',
            slackWebhook: '',
            itemsPerPage: 25,
            theme: 'light',
            refreshInterval: 'manual',
            compactMode: false
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadSampleData();
            updateLastUpdateTime();
            updateCurrentSettingsDisplay();
        });

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¨¡æ“¬ï¼‰
        function loadSampleData() {
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            inventoryData = [
                {
                    id: 'P001',
                    name: 'ãƒãƒ¼ãƒˆPC Acer Aspire',
                    category: 'PCãƒ»å‘¨è¾ºæ©Ÿå™¨',
                    currentStock: 3,
                    totalSales: 28,
                    dailyAverage: 2.0,
                    reorderPoint: 74,
                    shortage: 71,
                    status: 'danger',
                    needsReorder: true,
                    leadTime: 7,
                    supplier: 'ãƒ†ãƒƒã‚¯ã‚µãƒ—ãƒ©ã‚¤'
                },
                {
                    id: 'P002',
                    name: 'ãƒ—ãƒªãƒ³ã‚¿ç”¨ç´™ A4 500æš',
                    category: 'ã‚ªãƒ•ã‚£ã‚¹ç”¨å“',
                    currentStock: 5,
                    totalSales: 20,
                    dailyAverage: 1.4,
                    reorderPoint: 52,
                    shortage: 47,
                    status: 'danger',
                    needsReorder: true,
                    leadTime: 3,
                    supplier: 'ã‚ªãƒ•ã‚£ã‚¹ãƒãƒ¼ãƒˆ'
                },
                {
                    id: 'P003',
                    name: 'ãƒã‚¦ã‚¹ ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹',
                    category: 'PCãƒ»å‘¨è¾ºæ©Ÿå™¨',
                    currentStock: 8,
                    totalSales: 14,
                    dailyAverage: 1.0,
                    reorderPoint: 37,
                    shortage: 29,
                    status: 'warning',
                    needsReorder: true,
                    leadTime: 5,
                    supplier: 'ãƒ†ãƒƒã‚¯ã‚µãƒ—ãƒ©ã‚¤'
                },
                {
                    id: 'P004',
                    name: 'ã‚³ãƒ”ãƒ¼ç”¨ç´™ A3 250æš',
                    category: 'ã‚ªãƒ•ã‚£ã‚¹ç”¨å“',
                    currentStock: 15,
                    totalSales: 8,
                    dailyAverage: 0.6,
                    reorderPoint: 22,
                    shortage: 7,
                    status: 'warning',
                    needsReorder: true,
                    leadTime: 3,
                    supplier: 'ã‚ªãƒ•ã‚£ã‚¹ãƒãƒ¼ãƒˆ'
                },
                {
                    id: 'P005',
                    name: 'USBãƒ¡ãƒ¢ãƒª 32GB',
                    category: 'PCãƒ»å‘¨è¾ºæ©Ÿå™¨',
                    currentStock: 50,
                    totalSales: 35,
                    dailyAverage: 2.5,
                    reorderPoint: 93,
                    shortage: 43,
                    status: 'warning',
                    needsReorder: true,
                    leadTime: 7,
                    supplier: 'ãƒ†ãƒƒã‚¯ã‚µãƒ—ãƒ©ã‚¤'
                }
            ];

            // ç™ºæ³¨ä¸­ãƒ‡ãƒ¼ã‚¿
            orderedItems = [
                {
                    id: 'P006',
                    name: 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ ãƒ¡ã‚«ãƒ‹ã‚«ãƒ«',
                    category: 'PCãƒ»å‘¨è¾ºæ©Ÿå™¨',
                    currentStock: 1,
                    orderedQuantity: 20,
                    orderDate: '2025-07-01',
                    expectedDelivery: '2025-07-08',
                    status: 'ordered',
                    supplier: 'ãƒ†ãƒƒã‚¯ã‚µãƒ—ãƒ©ã‚¤'
                }
            ];

            updateSummaryCards();
            updateTables();
            updateCategoryFilter();
        }

        // ã‚¹ãƒãƒ¬ã‚¸CSVãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¯¾å¿œï¼‰
        function handleInventoryFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        uploadedInventoryData = parseSmaregiInventoryCSV(csv);
                        
                        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                        if (validateInventoryData(uploadedInventoryData)) {
                            document.getElementById('inventoryStatus').textContent = `âœ… ${uploadedInventoryData.length}ä»¶èª­ã¿è¾¼ã¿`;
                            document.getElementById('inventoryStatus').className = 'status-badge status-uploaded';
                            checkCalculateButtonState();
                        } else {
                            throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        }
                    } catch (error) {
                        document.getElementById('inventoryStatus').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        document.getElementById('inventoryStatus').className = 'status-badge status-error';
                        uploadedInventoryData = null;
                    }
                };
                reader.readAsText(file, 'shift_jis');
            }
        }

        function handleSalesFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        uploadedSalesData = parseSmaregiSalesCSV(csv);
                        
                        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                        if (validateSalesData(uploadedSalesData)) {
                            document.getElementById('salesStatus').textContent = `âœ… ${uploadedSalesData.length}ä»¶èª­ã¿è¾¼ã¿`;
                            document.getElementById('salesStatus').className = 'status-badge status-uploaded';
                            checkCalculateButtonState();
                        } else {
                            throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        }
                    } catch (error) {
                        document.getElementById('salesStatus').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        document.getElementById('salesStatus').className = 'status-badge status-error';
                        uploadedSalesData = null;
                    }
                };
                reader.readAsText(file, 'shift_jis');
            }
        }

        // ã‚¹ãƒãƒ¬ã‚¸å•†å“ãƒ‡ãƒ¼ã‚¿CSVè§£æï¼ˆå•†å“ãƒ‡ãƒ¼ã‚¿20250707150911.csvå½¢å¼ï¼‰
        function parseSmaregiInventoryCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && line.length > 0) {
                    // CSVè¡Œã‚’è§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 16) {
                        // Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Dåˆ—(éƒ¨é–€å), Fåˆ—(å•†å“å), Påˆ—(åœ¨åº«æ•°)ã‚’ä½¿ç”¨
                        const productCode = columns[2] || '';  // Cåˆ—: å•†å“ã‚³ãƒ¼ãƒ‰
                        const department = columns[3] || '';   // Dåˆ—: éƒ¨é–€å
                        const productName = columns[5] || '';  // Fåˆ—: å•†å“å
                        const currentStock = parseInt(columns[15]) || 0;  // Påˆ—: åœ¨åº«æ•°
                        
                        if (productCode && productName) {
                            data.push({
                                productId: productCode,
                                productName: productName,
                                category: department || 'æœªåˆ†é¡', // Dåˆ—ã®éƒ¨é–€åã‚’ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä½¿ç”¨
                                currentStock: currentStock,
                                supplier: 'æœªè¨­å®š',
                                unitCost: 0 // ä»•å…¥ä¾¡æ ¼ã®åˆ—ãŒä¸æ˜ã®ãŸã‚0ã«è¨­å®š
                            });
                        }
                    }
                }
            }
            return data;
        }

        // ã‚¹ãƒãƒ¬ã‚¸åœ¨åº«å±¥æ­´é›†è¨ˆCSVè§£æï¼ˆåœ¨åº«å±¥æ­´é›†è¨ˆ20250707153725.csvå½¢å¼ï¼‰
        function parseSmaregiSalesCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && line.length > 0) {
                    // CSVè¡Œã‚’è§£æ
                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 11) {
                        // Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Kåˆ—(è²©å£²æ•°)ã‚’ä½¿ç”¨
                        const productCode = columns[2] || '';  // Cåˆ—: å•†å“ã‚³ãƒ¼ãƒ‰
                        const salesQuantity = parseInt(columns[10]) || 0;  // Kåˆ—: è²©å£²æ•°
                        
                        if (productCode && salesQuantity > 0) {
                            data.push({
                                productId: productCode,
                                saleDate: new Date().toISOString().split('T')[0], // ä»Šæ—¥ã®æ—¥ä»˜
                                quantity: salesQuantity,
                                unitPrice: 0 // å˜ä¾¡æƒ…å ±ãŒãªã„å ´åˆã¯0
                            });
                        }
                    }
                }
            }
            return data;
        }

        // CSVè¡Œè§£æï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const delimiter = currentSettings.csvDelimiter;
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && (!currentSettings.skipEmptyRows || line.length > 0)) {
                    const values = line.split(delimiter).map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function validateInventoryData(data) {
            if (!data || data.length === 0) return false;
            
            // ã‚¹ãƒãƒ¬ã‚¸å•†å“ãƒ‡ãƒ¼ã‚¿ã®å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            const requiredFields = ['productId', 'productName', 'currentStock'];
            return data.every(row => 
                requiredFields.every(field => 
                    row[field] !== undefined && row[field] !== ''
                )
            );
        }

        function validateSalesData(data) {
            if (!data || data.length === 0) return false;
            
            // ã‚¹ãƒãƒ¬ã‚¸åœ¨åº«å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            const requiredFields = ['productId', 'quantity'];
            return data.every(row => 
                requiredFields.every(field => 
                    row[field] !== undefined && row[field] !== ''
                )
            );
        }

        function checkCalculateButtonState() {
            const button = document.getElementById('calculateBtn');
            if (uploadedInventoryData && uploadedSalesData) {
                button.disabled = false;
                button.textContent = 'ğŸ“Š ç™ºæ³¨ç‚¹ã‚’è¨ˆç®—';
            } else {
                button.disabled = true;
                button.textContent = 'ğŸ“Š CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
            }
        }

        function downloadSampleCSV() {
            // ã‚¹ãƒãƒ¬ã‚¸å½¢å¼ã®ã‚µãƒ³ãƒ—ãƒ«CSVã®ç”Ÿæˆ
            const inventorySample = 
                '"å•†å“ID","åº—èˆ—ID","å•†å“ã‚³ãƒ¼ãƒ‰","éƒ¨é–€å","å•†å“ä¾¡æ ¼","å•†å“å","å•†å“ã‚«ãƒ†ã‚´ãƒª","å•†å“å˜ä½","ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰","ã‚¿ã‚°","éƒ¨é–€","å£²ä¸Šç¨åŒºåˆ†","åœ¨åº«ç®¡ç†åŒºåˆ†","éƒ¨é–€","å£²ä¸Šè¡¨ç¤º","åœ¨åº«","å€¤å¼•ç‡","ç™»éŒ²æ—¥æ™‚","æ›´æ–°æ—¥æ™‚","å€¤å¼•ç‡","ç™»éŒ²æ—¥æ™‚","æ›´æ–°æ—¥æ™‚","å®‰å…¨åœ¨åº«ä¿‚æ•°","ã‚³ãƒ¼ãƒ‰å°å¸³","é¸æŠè‚¢1","é¸æŠè‚¢2","é¸æŠè‚¢3"\n' +
                '"1","1","P001","è‡ªå‹•è»Šéƒ¨å“","1000","P7 ãƒ‘ãƒ¼ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼50mm","è‡ªå‹•è»Šéƒ¨å“","å€‹","","","","","0","100","1","5","","2025/07/07 15:00:00","2025/07/07 15:00:00","","","","","","","",""\n' +
                '"2","1","P002","è‡ªå‹•è»Šéƒ¨å“","2000","P8 æ—¥ç”£ ãƒ•ãƒ­ãƒ³ãƒˆ ãƒãƒ–ãƒ™ã‚¢ãƒªãƒ³ã‚°","è‡ªå‹•è»Šéƒ¨å“","å€‹","","","","","0","100","1","10","","2025/07/07 15:00:00","2025/07/07 15:00:00","","","","","","","",""\n' +
                '"3","1","P003","è‡ªå‹•è»Šéƒ¨å“","1500","P9 ã‚¹ã‚ºã‚­ ã‚¸ãƒ ãƒ‹ãƒ¼ç”¨ ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ›ãƒ¼ã‚¹","è‡ªå‹•è»Šéƒ¨å“","å€‹","","","","","0","100","1","3","","2025/07/07 15:00:00","2025/07/07 15:00:00","","","","","","","",""\n';
            
            const salesSample = 
                '"å•†å“ID","ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰","å•†å“ã‚³ãƒ¼ãƒ‰","å•†å“å","ä»•å…¥:æ•°é‡","ä»•å…¥:é‡‘é¡åˆè¨ˆ","æ£šå¸:æ•°é‡","æ£šå¸:é‡‘é¡åˆè¨ˆ","è»¢å‡º:æ•°é‡","è»¢å‡º:é‡‘é¡åˆè¨ˆ","è²©å£²:æ•°é‡","è²©å£²:é‡‘é¡åˆè¨ˆ","è¿”å“:æ•°é‡","è¿”å“:é‡‘é¡åˆè¨ˆ","å‡ºåº«:æ•°é‡","å‡ºåº«:é‡‘é¡åˆè¨ˆ","é¸æŠ:æ•°é‡","é¸æŠ:é‡‘é¡åˆè¨ˆ","å»ƒæ£„:æ•°é‡","å»ƒæ£„:é‡‘é¡åˆè¨ˆ","æŒ¯æ›¿:æ•°é‡","æŒ¯æ›¿:é‡‘é¡åˆè¨ˆ","WebAPIã‚¢ãƒƒãƒ—:æ•°é‡","WebAPIã‚¢ãƒƒãƒ—:é‡‘é¡åˆè¨ˆ","æ‰‹å‹•ã‚¢ãƒƒãƒ—:æ•°é‡","æ‰‹å‹•ã‚¢ãƒƒãƒ—:é‡‘é¡åˆè¨ˆ","å–å¯„è²©å£²:æ•°é‡","å–å¯„è²©å£²:é‡‘é¡åˆè¨ˆ","è¿”å“å‡¦ç†:æ•°é‡","è¿”å“å‡¦ç†:é‡‘é¡åˆè¨ˆ","åˆè¨ˆ:æ•°é‡","åˆè¨ˆ:é‡‘é¡åˆè¨ˆ","åœ¨åº«æ¶ˆåŒ–ç‡"\n' +
                '"1","","P001","P7 ãƒ‘ãƒ¼ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼50mm","0","0.00","0","0.00","0","0.00","5","5000.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","5","5000.00","50.00"\n' +
                '"2","","P002","P8 æ—¥ç”£ ãƒ•ãƒ­ãƒ³ãƒˆ ãƒãƒ–ãƒ™ã‚¢ãƒªãƒ³ã‚°","0","0.00","0","0.00","0","0.00","3","6000.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","3","6000.00","30.00"\n' +
                '"3","","P003","P9 ã‚¹ã‚ºã‚­ ã‚¸ãƒ ãƒ‹ãƒ¼ç”¨ ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ›ãƒ¼ã‚¹","0","0.00","0","0.00","0","0.00","8","12000.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","0","0.00","8","12000.00","80.00"\n';
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
            const combinedSample = 
                '=== å•†å“ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ« (å•†å“ãƒ‡ãƒ¼ã‚¿20250707150911.csvå½¢å¼) ===\n' +
                'ä½¿ç”¨ã™ã‚‹åˆ—: Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Dåˆ—(éƒ¨é–€å), Fåˆ—(å•†å“å), Påˆ—(åœ¨åº«æ•°)\n\n' +
                inventorySample + '\n\n' +
                '=== åœ¨åº«å±¥æ­´é›†è¨ˆã‚µãƒ³ãƒ—ãƒ« (åœ¨åº«å±¥æ­´é›†è¨ˆ20250707153725.csvå½¢å¼) ===\n' +
                'ä½¿ç”¨ã™ã‚‹åˆ—: Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Kåˆ—(è²©å£²æ•°é‡)\n\n' +
                salesSample;
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([combinedSample], { type: 'text/plain; charset=shift_jis' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'smaregi_sample_format.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('ã‚¹ãƒãƒ¬ã‚¸CSVã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\n\nã€é‡è¦ã€‘\n' +
                  'ãƒ»å•†å“ãƒ‡ãƒ¼ã‚¿: Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Dåˆ—(éƒ¨é–€å), Fåˆ—(å•†å“å), Påˆ—(åœ¨åº«æ•°)\n' +
                  'ãƒ»åœ¨åº«å±¥æ­´é›†è¨ˆ: Cåˆ—(å•†å“ã‚³ãƒ¼ãƒ‰), Kåˆ—(è²©å£²æ•°é‡)\n' +
                  'ãƒ»ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: Shift-JIS\n' +
                  'ãƒ»ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰è©²å½“ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„');
        }

        // è¨­å®šé–¢é€£ã®é–¢æ•°
        function showSettings() {
            // ç¾åœ¨ã®è¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            document.getElementById('analysisWeeks').value = currentSettings.analysisWeeks;
            document.getElementById('leadTime').value = currentSettings.leadTime;
            document.getElementById('safetyStock').value = currentSettings.safetyStock;
            document.getElementById('urgentThreshold').value = currentSettings.urgentThreshold;
            document.getElementById('autoCalculate').value = currentSettings.autoCalculate;
            document.getElementById('csvEncoding').value = currentSettings.csvEncoding;
            document.getElementById('csvDelimiter').value = currentSettings.csvDelimiter;
            document.getElementById('validateData').checked = currentSettings.validateData;
            document.getElementById('skipEmptyRows').checked = currentSettings.skipEmptyRows;
            document.getElementById('autoCorrectData').checked = currentSettings.autoCorrectData;
            document.getElementById('googleScriptUrl').value = currentSettings.googleScriptUrl;
            document.getElementById('emailNotification').value = currentSettings.emailNotification;
            document.getElementById('emailAddress').value = currentSettings.emailAddress;
            document.getElementById('slackNotification').value = currentSettings.slackNotification;
            document.getElementById('slackWebhook').value = currentSettings.slackWebhook;
            document.getElementById('itemsPerPage').value = currentSettings.itemsPerPage;
            document.getElementById('theme').value = currentSettings.theme;
            document.getElementById('refreshInterval').value = currentSettings.refreshInterval;
            document.getElementById('compactMode').value = currentSettings.compactMode;
            
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showSettingsTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.settings-tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-settings').classList.add('active');
        }

        function saveSettings() {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¨­å®šã‚’å–å¾—
            currentSettings.analysisWeeks = parseInt(document.getElementById('analysisWeeks').value);
            currentSettings.leadTime = parseInt(document.getElementById('leadTime').value);
            currentSettings.safetyStock = parseInt(document.getElementById('safetyStock').value);
            currentSettings.urgentThreshold = parseInt(document.getElementById('urgentThreshold').value);
            currentSettings.autoCalculate = document.getElementById('autoCalculate').value;
            currentSettings.csvEncoding = document.getElementById('csvEncoding').value;
            currentSettings.csvDelimiter = document.getElementById('csvDelimiter').value;
            currentSettings.validateData = document.getElementById('validateData').checked;
            currentSettings.skipEmptyRows = document.getElementById('skipEmptyRows').checked;
            currentSettings.autoCorrectData = document.getElementById('autoCorrectData').checked;
            currentSettings.googleScriptUrl = document.getElementById('googleScriptUrl').value;
            currentSettings.emailNotification = document.getElementById('emailNotification').value;
            currentSettings.emailAddress = document.getElementById('emailAddress').value;
            currentSettings.slackNotification = document.getElementById('slackNotification').value;
            currentSettings.slackWebhook = document.getElementById('slackWebhook').value;
            currentSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentSettings.theme = document.getElementById('theme').value;
            currentSettings.refreshInterval = document.getElementById('refreshInterval').value;
            currentSettings.compactMode = document.getElementById('compactMode').value === 'true';

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('inventorySettings', JSON.stringify(currentSettings));
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            updateCurrentSettingsDisplay();
            
            // è¨­å®šä¿å­˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            closeSettings();
        }

        function loadSettings() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedSettings = localStorage.getItem('inventorySettings');
            if (savedSettings) {
                currentSettings = { ...currentSettings, ...JSON.parse(savedSettings) };
            }
        }

        function resetSettings() {
            if (confirm('è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã™
                currentSettings = {
                    analysisWeeks: 2,
                    leadTime: 7,
                    safetyStock: 3,
                    urgentThreshold: 50,
                    autoCalculate: 'manual',
                    csvEncoding: 'shift_jis',
                    csvDelimiter: ',',
                    validateData: true,
                    skipEmptyRows: true,
                    autoCorrectData: false,
                    googleScriptUrl: '',
                    emailNotification: 'disabled',
                    emailAddress: '',
                    slackNotification: 'disabled',
                    slackWebhook: '',
                    itemsPerPage: 25,
                    theme: 'light',
                    refreshInterval: 'manual',
                    compactMode: false
                };
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
                showSettings();
                updateCurrentSettingsDisplay();
                
                alert('è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸï¼');
            }
        }

        function updateCurrentSettingsDisplay() {
            const settingsText = `åˆ†ææœŸé–“: ${currentSettings.analysisWeeks}é€±é–“ | ç™ºæ³¨ç‚¹: æ—¥å¹³å‡å‡ºè·æ•° Ã— 37æ—¥`;
            document.getElementById('currentSettings').textContent = settingsText;
        }

        function calculateFromCSV() {
            if (!uploadedInventoryData || !uploadedSalesData) {
                alert('å•†å“ãƒ‡ãƒ¼ã‚¿ã¨åœ¨åº«å±¥æ­´é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ç™ºæ³¨ç‚¹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚«ã‚¹ã‚¿ãƒ è¨ˆç®—å¼ï¼‰
            const analysisWeeks = currentSettings.analysisWeeks;
            const analysisDays = analysisWeeks * 7; // åˆ†ææœŸé–“ï¼ˆæ—¥æ•°ï¼‰
            const reorderCalculationDays = 37; // ç™ºæ³¨ç‚¹è¨ˆç®—ç”¨ã®æ—¥æ•°ï¼ˆå›ºå®šï¼‰

            // è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’å•†å“åˆ¥ã«é›†è¨ˆ
            const salesMap = new Map();
            uploadedSalesData.forEach(sale => {
                const productId = sale.productId;
                const quantity = parseInt(sale.quantity) || 0;
                if (salesMap.has(productId)) {
                    salesMap.set(productId, salesMap.get(productId) + quantity);
                } else {
                    salesMap.set(productId, quantity);
                }
            });

            // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã¨è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦ç™ºæ³¨ç‚¹ã‚’è¨ˆç®—
            const calculatedData = uploadedInventoryData.map(item => {
                const productId = item.productId;
                const currentStock = parseInt(item.currentStock) || 0;
                const totalSales = salesMap.get(productId) || 0;
                
                // æ—¥å¹³å‡å‡ºè·æ•°ã‚’è¨ˆç®—
                const dailyAverage = totalSales / analysisDays;
                
                // ç™ºæ³¨ç‚¹è¨ˆç®—: å‡ºè·æ•°/14*37ï¼è²©å£²æ•°
                const reorderPoint = Math.ceil(dailyAverage * reorderCalculationDays);
                
                // ç™ºæ³¨åˆ¤å®š: åœ¨åº«æ•° < è²©å£²æ•° = ç™ºæ³¨ç‚¹
                const needsReorder = currentStock < reorderPoint;
                const shortage = Math.max(0, reorderPoint - currentStock);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
                let status = 'normal';
                if (needsReorder) {
                    // ç·Šæ€¥åº¦ã®è¨ˆç®—ï¼ˆåœ¨åº«ãŒã©ã®ç¨‹åº¦ä¸è¶³ã—ã¦ã„ã‚‹ã‹ï¼‰
                    const shortageRatio = shortage / reorderPoint;
                    if (shortageRatio >= 0.5) { // 50%ä»¥ä¸Šä¸è¶³
                        status = 'danger';
                    } else {
                        status = 'warning';
                    }
                }

                return {
                    id: productId,
                    name: item.productName,
                    category: item.category || 'æœªåˆ†é¡',
                    currentStock: currentStock,
                    totalSales: totalSales,
                    dailyAverage: Math.round(dailyAverage * 100) / 100,
                    reorderPoint: reorderPoint,
                    shortage: shortage,
                    status: status,
                    needsReorder: needsReorder,
                    leadTime: currentSettings.leadTime,
                    supplier: item.supplier || 'æœªè¨­å®š'
                };
            });

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            inventoryData = calculatedData;
            
            // ç”»é¢ã‚’æ›´æ–°
            updateSummaryCards();
            updateTables();
            updateCategoryFilter();
            updateLastUpdateTime();
            document.getElementById('lastCalculation').textContent = `æœ€çµ‚è¨ˆç®—: ${new Date().toLocaleString('ja-JP')}`;
            
            // è¨ˆç®—çµæœã®ã‚µãƒãƒªãƒ¼
            const reorderCount = calculatedData.filter(item => item.needsReorder).length;
            const dangerCount = calculatedData.filter(item => item.status === 'danger').length;
            const warningCount = calculatedData.filter(item => item.status === 'warning').length;
            
            alert(`ç™ºæ³¨ç‚¹è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n` +
                  `ã€è¨ˆç®—å¼ã€‘\n` +
                  `æ—¥å¹³å‡å‡ºè·æ•° = ${analysisWeeks}é€±é–“å‡ºè·æ•° Ã· ${analysisDays}æ—¥\n` +
                  `ç™ºæ³¨ç‚¹ = æ—¥å¹³å‡å‡ºè·æ•° Ã— 37æ—¥\n` +
                  `ç™ºæ³¨åˆ¤å®š = åœ¨åº«æ•° < ç™ºæ³¨ç‚¹\n\n` +
                  `ã€çµæœã€‘\n` +
                  `å‡¦ç†ä»¶æ•°: ${calculatedData.length}ä»¶\n` +
                  `ç™ºæ³¨å¿…è¦: ${reorderCount}ä»¶\n` +
                  `ã€€â”œ ç·Šæ€¥: ${dangerCount}ä»¶\n` +
                  `ã€€â”” æ³¨æ„: ${warningCount}ä»¶`);
        }

        // ç™ºæ³¨ç‚¹è¨ˆç®—
        function calculateReorderPoints() {
            calculateFromCSV();
        }

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshData() {
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
            // å®Ÿéš›ã«ã¯APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            updateLastUpdateTime();
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
        }

        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
        function updateSummaryCards() {
            const urgentCount = inventoryData.filter(item => item.status === 'danger').length;
            const warningCount = inventoryData.filter(item => item.status === 'warning').length;
            const orderedCount = orderedItems.length;
            const normalCount = inventoryData.filter(item => item.status === 'normal').length;

            document.getElementById('urgentCount').textContent = urgentCount;
            document.getElementById('warningCount').textContent = warningCount;
            document.getElementById('orderedCount').textContent = orderedCount;
            document.getElementById('normalCount').textContent = normalCount;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateTables() {
            updateReorderTable();
            updateOrderedTable();
            updateAllTable();
        }

        // ç™ºæ³¨å¿…è¦ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateReorderTable() {
            const tbody = document.getElementById('reorderTableBody');
            const reorderItems = inventoryData.filter(item => item.needsReorder);
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedReorderItems.clear();
            updateReorderSelection();
            
            if (reorderItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">ç™ºæ³¨ãŒå¿…è¦ãªå•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = reorderItems.map(item => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="toggleReorderItemSelection('${item.id}')">
                    </td>
                    <td>
                        <div class="product-name-container">
                            <span class="product-code" onclick="copyToClipboard('${item.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">${item.id}</span>
                            <span class="product-name">${item.name}</span>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td><span class="number-${item.currentStock <= 5 ? 'negative' : 'neutral'}">${item.currentStock}</span></td>
                    <td>${item.reorderPoint}</td>
                    <td><span class="number-negative">${item.shortage}</span></td>
                    <td>${item.dailyAverage}</td>
                    <td><span class="status-badge status-${item.status}">${getPriorityText(item.status)}</span></td>
                    <td class="action-column">
                        <button class="btn btn-success btn-sm" onclick="markSingleAsOrdered('${item.id}')">ç™ºæ³¨</button>
                    </td>
                </tr>
            `).join('');
        }

        // ç™ºæ³¨ä¸­ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateOrderedTable() {
            const tbody = document.getElementById('orderedTableBody');
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedOrderedItems.clear();
            updateOrderedSelection();
            
            if (orderedItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">ç™ºæ³¨ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = orderedItems.map(item => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="toggleOrderedItemSelection('${item.id}')">
                    </td>
                    <td>
                        <div class="product-name-container">
                            <span class="product-code" onclick="copyToClipboard('${item.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">${item.id}</span>
                            <span class="product-name">${item.name}</span>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td>${item.currentStock}</td>
                    <td>${item.orderedQuantity}</td>
                    <td>${item.orderDate}</td>
                    <td>${item.expectedDelivery}</td>
                    <td><span class="status-badge status-ordered">ç™ºæ³¨ä¸­</span></td>
                    <td class="action-column">
                        <button class="btn btn-sm btn-success" onclick="completeOrder('${item.id}')">å…¥è·</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder('${item.id}')">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // å…¨å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateAllTable() {
            const tbody = document.getElementById('allTableBody');
            
            tbody.innerHTML = inventoryData.map(item => `
                <tr>
                    <td>
                        <div class="product-name-container">
                            <span class="product-code" onclick="copyToClipboard('${item.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">${item.id}</span>
                            <span class="product-name">${item.name}</span>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td><span class="number-${item.currentStock <= 5 ? 'negative' : 'neutral'}">${item.currentStock}</span></td>
                    <td>${item.reorderPoint}</td>
                    <td>${item.dailyAverage}</td>
                    <td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
                    <td class="action-column">
                        <button class="btn" onclick="showProductDetail('${item.id}')">è©³ç´°</button>
                    </td>
                </tr>
            `).join('');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getStatusText(status) {
            switch(status) {
                case 'danger': return 'ç·Šæ€¥';
                case 'warning': return 'æ³¨æ„';
                case 'normal': return 'æ­£å¸¸';
                case 'ordered': return 'ç™ºæ³¨ä¸­';
                default: return 'ä¸æ˜';
            }
        }

        // å„ªå…ˆåº¦ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getPriorityText(status) {
            switch(status) {
                case 'danger': return 'ç·Šæ€¥';
                case 'warning': return 'æ³¨æ„';
                default: return 'æ­£å¸¸';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const titles = {
                'reorder': 'ç™ºæ³¨ãŒå¿…è¦ãªå•†å“',
                'ordered': 'ç™ºæ³¨ä¸­ã®å•†å“',
                'all': 'å…¨å•†å“ä¸€è¦§'
            };
            document.getElementById('currentTabTitle').textContent = titles[tabName];
            currentTab = tabName;
        }

        // ç™ºæ³¨é¸æŠé–¢é€£ã®é–¢æ•°
        function toggleSelectAllReorder() {
            const selectAllCheckbox = document.getElementById('selectAllReorder');
            const reorderItems = inventoryData.filter(item => item.needsReorder);
            
            if (selectAllCheckbox.checked) {
                reorderItems.forEach(item => selectedReorderItems.add(item.id));
            } else {
                selectedReorderItems.clear();
            }
            
            // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            document.querySelectorAll('#reorderTableBody .item-checkbox').forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateReorderSelection();
        }

        function toggleReorderItemSelection(itemId) {
            const checkbox = document.querySelector(`#reorderTableBody .item-checkbox[data-id="${itemId}"]`);
            
            if (checkbox.checked) {
                selectedReorderItems.add(itemId);
            } else {
                selectedReorderItems.delete(itemId);
            }
            
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const totalItems = inventoryData.filter(item => item.needsReorder).length;
            const selectAllCheckbox = document.getElementById('selectAllReorder');
            selectAllCheckbox.checked = selectedReorderItems.size === totalItems;
            
            updateReorderSelection();
        }

        function updateReorderSelection() {
            const count = selectedReorderItems.size;
            document.getElementById('reorderSelectedCount').textContent = `${count}ä»¶é¸æŠ`;
            document.getElementById('moveToOrderedBtn').disabled = count === 0;
        }

        function toggleSelectAllOrdered() {
            const selectAllCheckbox = document.getElementById('selectAllOrdered');
            
            if (selectAllCheckbox.checked) {
                orderedItems.forEach(item => selectedOrderedItems.add(item.id));
            } else {
                selectedOrderedItems.clear();
            }
            
            // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            document.querySelectorAll('#orderedTableBody .item-checkbox').forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateOrderedSelection();
        }

        function toggleOrderedItemSelection(itemId) {
            const checkbox = document.querySelector(`#orderedTableBody .item-checkbox[data-id="${itemId}"]`);
            
            if (checkbox.checked) {
                selectedOrderedItems.add(itemId);
            } else {
                selectedOrderedItems.delete(itemId);
            }
            
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const selectAllCheckbox = document.getElementById('selectAllOrdered');
            selectAllCheckbox.checked = selectedOrderedItems.size === orderedItems.length;
            
            updateOrderedSelection();
        }

        function updateOrderedSelection() {
            const count = selectedOrderedItems.size;
            document.getElementById('orderedSelectedCount').textContent = `${count}ä»¶é¸æŠ`;
            document.getElementById('completeOrdersBtn').disabled = count === 0;
            document.getElementById('deleteOrdersBtn').disabled = count === 0;
        }

        // é¸æŠå•†å“ã‚’ç™ºæ³¨ä¸­ã«ç§»å‹•
        function moveSelectedToOrdered() {
            if (selectedReorderItems.size === 0) {
                alert('ç™ºæ³¨ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // é¸æŠå•†å“ã‚’å–å¾—
            itemsToOrder = inventoryData.filter(item => selectedReorderItems.has(item.id));
            
            // ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            showOrderModal();
        }

        // ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showOrderModal() {
            const modal = document.getElementById('orderModal');
            const itemsList = document.getElementById('orderItemsList');
            
            // é¸æŠå•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            itemsList.innerHTML = `
                <h4>ç™ºæ³¨äºˆå®šå•†å“ (${itemsToOrder.length}ä»¶)</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${itemsToOrder.map(item => 
                        `<li><span class="product-code" onclick="copyToClipboard('${item.id}')" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">${item.id}</span> ${item.name} (ä¸è¶³æ•°: ${item.shortage}å€‹)</li>`
                    ).join('')}
                </ul>
            `;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            const today = new Date();
            const defaultDelivery = new Date(today.getTime() + (currentSettings.leadTime * 24 * 60 * 60 * 1000));
            document.getElementById('expectedDelivery').value = defaultDelivery.toISOString().split('T')[0];
            
            modal.style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('orderQuantity').value = '';
            document.getElementById('expectedDelivery').value = '';
            document.getElementById('orderMemo').value = '';
        }

        // ç™ºæ³¨ç¢ºå®š
        function confirmOrder() {
            const orderQuantity = parseInt(document.getElementById('orderQuantity').value);
            const expectedDelivery = document.getElementById('expectedDelivery').value;
            const orderMemo = document.getElementById('orderMemo').value;
            
            if (!orderQuantity || orderQuantity <= 0) {
                alert('ç™ºæ³¨æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!expectedDelivery) {
                alert('äºˆå®šç´æœŸã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            // é¸æŠå•†å“ã‚’ç™ºæ³¨ä¸­ã«ç§»å‹•
            itemsToOrder.forEach(item => {
                orderedItems.push({
                    id: item.id,
                    name: item.name,
                    category: item.category,
                    currentStock: item.currentStock,
                    orderedQuantity: orderQuantity,
                    orderDate: today,
                    expectedDelivery: expectedDelivery,
                    status: 'ordered',
                    supplier: item.supplier,
                    memo: orderMemo
                });
            });
            
            // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
            inventoryData = inventoryData.filter(item => !selectedReorderItems.has(item.id));
            
            // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedReorderItems.clear();
            
            // ç”»é¢æ›´æ–°
            updateSummaryCards();
            updateTables();
            closeOrderModal();
            
            alert(`${itemsToOrder.length}ä»¶ã®å•†å“ã‚’ç™ºæ³¨ä¸­ã«ç§»å‹•ã—ã¾ã—ãŸï¼`);
        }

        // å˜ä¸€å•†å“ç™ºæ³¨
        function markSingleAsOrdered(productId) {
            const item = inventoryData.find(item => item.id === productId);
            if (item) {
                selectedReorderItems.clear();
                selectedReorderItems.add(productId);
                itemsToOrder = [item];
                showOrderModal();
            }
        }

        // ç™ºæ³¨å®Œäº†ï¼ˆå…¥è·ï¼‰
        function completeOrder(productId) {
            if (confirm('ã“ã®å•†å“ã®å…¥è·ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                const item = orderedItems.find(item => item.id === productId);
                if (item) {
                    // åœ¨åº«ã‚’æ›´æ–°ã—ã¦å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™
                    const updatedStock = item.currentStock + item.orderedQuantity;
                    
                    // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™ï¼ˆç™ºæ³¨ç‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                    const originalItem = {
                        id: item.id,
                        name: item.name,
                        category: item.category,
                        currentStock: updatedStock,
                        totalSales: 0, // å†è¨ˆç®—ãŒå¿…è¦
                        dailyAverage: 0,
                        reorderPoint: 0,
                        shortage: 0,
                        status: 'normal',
                        leadTime: currentSettings.leadTime,
                        supplier: item.supplier
                    };
                    
                    inventoryData.push(originalItem);
                    
                    // ç™ºæ³¨ä¸­ã‹ã‚‰å‰Šé™¤
                    orderedItems = orderedItems.filter(i => i.id !== productId);
                    
                    updateSummaryCards();
                    updateTables();
                    
                    alert(`${item.name}ã®å…¥è·ã‚’å®Œäº†ã—ã¾ã—ãŸï¼\nåœ¨åº«æ•°: ${item.currentStock} â†’ ${updatedStock}`);
                }
            }
        }

        // ç™ºæ³¨å‰Šé™¤
        function deleteOrder(productId) {
            if (confirm('ã“ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å•†å“ã¯ç™ºæ³¨å¿…è¦ãƒªã‚¹ãƒˆã«æˆ»ã‚Šã¾ã™')) {
                const item = orderedItems.find(item => item.id === productId);
                if (item) {
                    // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™
                    const originalItem = {
                        id: item.id,
                        name: item.name,
                        category: item.category,
                        currentStock: item.currentStock,
                        totalSales: 0, // å†è¨ˆç®—ãŒå¿…è¦
                        dailyAverage: 0,
                        reorderPoint: 0,
                        shortage: 0,
                        status: 'warning', // ç™ºæ³¨å¿…è¦ã¨ã—ã¦æˆ»ã™
                        leadTime: currentSettings.leadTime,
                        supplier: item.supplier
                    };
                    
                    inventoryData.push(originalItem);
                    
                    // ç™ºæ³¨ä¸­ã‹ã‚‰å‰Šé™¤
                    orderedItems = orderedItems.filter(i => i.id !== productId);
                    
                    updateSummaryCards();
                    updateTables();
                    
                    alert(`${item.name}ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼`);
                }
            }
        }

        // é¸æŠå•†å“ã‚’å…¥è·å®Œäº†
        function completeSelectedOrders() {
            if (selectedOrderedItems.size === 0) {
                alert('å…¥è·å®Œäº†ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (confirm(`é¸æŠã—ãŸ${selectedOrderedItems.size}ä»¶ã®å•†å“ã®å…¥è·ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const completedItems = [];
                
                selectedOrderedItems.forEach(itemId => {
                    const item = orderedItems.find(item => item.id === itemId);
                    if (item) {
                        const updatedStock = item.currentStock + item.orderedQuantity;
                        
                        // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™
                        const originalItem = {
                            id: item.id,
                            name: item.name,
                            category: item.category,
                            currentStock: updatedStock,
                            totalSales: 0,
                            dailyAverage: 0,
                            reorderPoint: 0,
                            shortage: 0,
                            status: 'normal',
                            leadTime: currentSettings.leadTime,
                            supplier: item.supplier
                        };
                        
                        inventoryData.push(originalItem);
                        completedItems.push(item.name);
                    }
                });
                
                // ç™ºæ³¨ä¸­ã‹ã‚‰å‰Šé™¤
                orderedItems = orderedItems.filter(item => !selectedOrderedItems.has(item.id));
                selectedOrderedItems.clear();
                
                updateSummaryCards();
                updateTables();
                
                alert(`${completedItems.length}ä»¶ã®å•†å“ã®å…¥è·ã‚’å®Œäº†ã—ã¾ã—ãŸï¼\n\nå®Œäº†å•†å“:\n${completedItems.join('\n')}`);
            }
        }

        // é¸æŠå•†å“ã‚’å‰Šé™¤
        function deleteSelectedOrders() {
            if (selectedOrderedItems.size === 0) {
                alert('å‰Šé™¤ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // å…¨é¸æŠã®å ´åˆã¯ç‰¹åˆ¥ãªè­¦å‘Š
            const isSelectAll = selectedOrderedItems.size === orderedItems.length;
            const warningMessage = isSelectAll 
                ? `âš ï¸ å…¨ã¦ã®ç™ºæ³¨ä¸­å•†å“ï¼ˆ${selectedOrderedItems.size}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nå‰Šé™¤ã•ã‚ŒãŸå•†å“ã¯ç™ºæ³¨å¿…è¦ãƒªã‚¹ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚`
                : `é¸æŠã—ãŸ${selectedOrderedItems.size}ä»¶ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰Šé™¤ã•ã‚ŒãŸå•†å“ã¯ç™ºæ³¨å¿…è¦ãƒªã‚¹ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚`;
            
            if (confirm(warningMessage)) {
                const deletedItems = [];
                
                selectedOrderedItems.forEach(itemId => {
                    const item = orderedItems.find(item => item.id === itemId);
                    if (item) {
                        // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™
                        const originalItem = {
                            id: item.id,
                            name: item.name,
                            category: item.category,
                            currentStock: item.currentStock,
                            totalSales: 0,
                            dailyAverage: 0,
                            reorderPoint: 0,
                            shortage: 0,
                            status: 'warning',
                            leadTime: currentSettings.leadTime,
                            supplier: item.supplier
                        };
                        
                        inventoryData.push(originalItem);
                        deletedItems.push(item.name);
                    }
                });
                
                // ç™ºæ³¨ä¸­ã‹ã‚‰å‰Šé™¤
                orderedItems = orderedItems.filter(item => !selectedOrderedItems.has(item.id));
                selectedOrderedItems.clear();
                
                updateSummaryCards();
                updateTables();
                
                alert(`${deletedItems.length}ä»¶ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼\n\nå‰Šé™¤å•†å“:\n${deletedItems.join('\n')}`);
            }
        }

        // ç™ºæ³¨æ¸ˆã¿ãƒãƒ¼ã‚¯ï¼ˆæ—§é–¢æ•° - äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function markAsOrdered(productId) {
            const item = inventoryData.find(item => item.id === productId);
            if (item) {
                const orderQuantity = prompt('ç™ºæ³¨æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', item.shortage);
                if (orderQuantity && parseInt(orderQuantity) > 0) {
                    // ç™ºæ³¨ä¸­ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    orderedItems.push({
                        id: item.id,
                        name: item.name,
                        category: item.category,
                        currentStock: item.currentStock,
                        orderedQuantity: parseInt(orderQuantity),
                        orderDate: new Date().toISOString().split('T')[0],
                        expectedDelivery: new Date(Date.now() + item.leadTime * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ordered',
                        supplier: item.supplier
                    });

                    // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
                    inventoryData = inventoryData.filter(i => i.id !== productId);
                    
                    updateSummaryCards();
                    updateTables();
                    alert('ç™ºæ³¨æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸï¼');
                }
            }
        }

        // ç™ºæ³¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæ—§é–¢æ•° - äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function cancelOrder(productId) {
            if (confirm('ç™ºæ³¨ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
                const item = orderedItems.find(item => item.id === productId);
                if (item) {
                    // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ç°¡ç•¥åŒ–ï¼‰
                    orderedItems = orderedItems.filter(i => i.id !== productId);
                    
                    updateSummaryCards();
                    updateTables();
                    alert('ç™ºæ³¨ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸï¼');
                }
            }
        }

        // å•†å“è©³ç´°è¡¨ç¤º
        function showProductDetail(productId) {
            const item = inventoryData.find(item => item.id === productId);
            if (item) {
                alert(`å•†å“è©³ç´°\n\nå•†å“ã‚³ãƒ¼ãƒ‰: ${item.id}\nå•†å“å: ${item.name}\nã‚«ãƒ†ã‚´ãƒª: ${item.category}\nç¾åœ¨åœ¨åº«: ${item.currentStock}\nç™ºæ³¨ç‚¹: ${item.reorderPoint}\næ—¥å¹³å‡è²©å£²: ${item.dailyAverage}\nä»•å…¥å…ˆ: ${item.supplier}`);
            }
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showCopyNotification();
            }).catch(function() {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyNotification();
            });
        }

        // ã‚³ãƒ”ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateCategoryFilter() {
            const categories = [...new Set(inventoryData.map(item => item.category))];
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function filterTable() {
            // å®Ÿè£…çœç•¥ - å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è©³ç´°å®Ÿè£…
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­...');
        }

        function filterByCategory() {
            // å®Ÿè£…çœç•¥ - å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è©³ç´°å®Ÿè£…
            console.log('ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­...');
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºé–¢æ•°
        async function syncFromSpreadsheet() {
            if (!currentSettings.googleScriptUrl) {
                alert('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const inventoryResponse = await fetch(currentSettings.googleScriptUrl + '?action=getInventory');
                const inventoryData = await inventoryResponse.json();

                // è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const salesResponse = await fetch(currentSettings.googleScriptUrl + '?action=getSales');
                const salesData = await salesResponse.json();

                uploadedInventoryData = inventoryData;
                uploadedSalesData = salesData;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                document.getElementById('inventoryStatus').textContent = `âœ… ${inventoryData.length}ä»¶èª­ã¿è¾¼ã¿`;
                document.getElementById('inventoryStatus').className = 'status-badge status-uploaded';
                document.getElementById('salesStatus').textContent = `âœ… ${salesData.length}ä»¶èª­ã¿è¾¼ã¿`;
                document.getElementById('salesStatus').className = 'status-badge status-uploaded';

                checkCalculateButtonState();
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼');
            } catch (error) {
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function syncToSpreadsheet() {
            if (!currentSettings.googleScriptUrl) {
                alert('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            if (!inventoryData.length) {
                alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const response = await fetch(currentSettings.googleScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateInventory',
                        data: inventoryData
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        window.addEventListener('click', function(e) {
            const settingsModal = document.getElementById('settingsModal');
            const orderModal = document.getElementById('orderModal');
            
            if (e.target === settingsModal) {
                closeSettings();
            }
            if (e.target === orderModal) {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>
