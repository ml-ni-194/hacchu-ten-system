<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在庫管理ダッシュボード</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 設定パネル */
        .settings-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .setting-group input,
        .setting-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        /* サマリーカード */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-card .label {
            color: #666;
            font-size: 14px;
        }

        .summary-card.alert {
            border-left: 4px solid #e74c3c;
        }

        .summary-card.warning {
            border-left: 4px solid #f39c12;
        }

        .summary-card.success {
            border-left: 4px solid #27ae60;
        }

        .summary-card.info {
            border-left: 4px solid #3498db;
        }

        /* データテーブル */
        .data-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* ステータスバッジ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-normal {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .status-ordered {
            background: #cce5ff;
            color: #0056b3;
        }

        .status-on-hold {
            background: #ffeaa7;
            color: #b8860b;
        }

        /* 数値カラー */
        .number-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .number-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .number-neutral {
            color: #333;
        }

        /* 商品コード表示 */
        .product-code {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #666;
            margin-right: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .product-code:hover {
            background: #e0e0e0;
        }

        .product-name-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .product-name {
            flex: 1;
            min-width: 200px;
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .copy-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box {
                width: 100%;
            }
        }

        /* ローディング */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* タブ */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
            align-items: center;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-copy-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
            transition: background 0.3s;
        }

        .tab-copy-btn:hover {
            background: #8e44ad;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* アップロード関連スタイル */
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upload-group label {
            font-weight: bold;
            color: #2c3e50;
        }

        .upload-group input[type="file"] {
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-group input[type="file"]:hover {
            border-color: #3498db;
        }

        .upload-group small {
            color: #666;
            font-size: 12px;
        }

        .upload-status {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .status-uploaded {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .current-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .current-settings h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .csv-format-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .csv-format-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .csv-format-info li {
            margin: 5px 0;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }

        /* 選択機能用スタイル */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-controls {
            display: flex;
            gap: 10px;
        }

        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .selected-count {
            color: #3498db;
            font-weight: bold;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .action-column {
            width: 120px;
            text-align: center;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        /* 発注フォーム */
        .order-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group-inline {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .form-group-inline label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .form-group-inline input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .upload-status {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* 設定モーダル用スタイル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            max-width: 500px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            margin: 0;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: white;
            z-index: 1001;
        }

        .close:hover {
            opacity: 0.7;
        }

        /* 設定タブ */
        .settings-tab-container {
            padding: 0 20px;
        }

        .settings-tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .settings-tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .settings-tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .settings-tab-content {
            display: none;
            padding: 0 20px;
        }

        .settings-tab-content.active {
            display: block;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .settings-form .setting-group {
            display: flex;
            flex-direction: column;
        }

        .settings-form .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .settings-form .setting-group input,
        .settings-form .setting-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .settings-form .setting-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .settings-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .settings-tab-buttons {
                flex-wrap: wrap;
            }
            
            .settings-tab-button {
                flex: 1;
                min-width: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">📊 在庫管理システム</div>
            <div class="user-info">
                <span id="lastUpdate">最終更新: --:--</span>
                <button class="btn" onclick="refreshData()">🔄 更新</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- クイックアクションパネル -->
        <div class="settings-panel">
            <h3>📁 データアップロード</h3>
            <div class="upload-section">
                <div class="upload-group">
                    <label for="inventoryFile">📦 商品データCSV</label>
                    <input type="file" id="inventoryFile" accept=".csv" onchange="handleInventoryFileUpload(event)">
                    <small>スマレジの商品データCSVファイル (商品データ20250707150911.csv形式)</small>
                </div>
                <div class="upload-group">
                    <label for="salesFile">📊 在庫履歴集計CSV</label>
                    <input type="file" id="salesFile" accept=".csv" onchange="handleSalesFileUpload(event)">
                    <small>スマレジの在庫履歴集計CSVファイル (在庫履歴集計20250707153725.csv形式)</small>
                </div>
            </div>
            <div class="upload-status">
                <div class="status-item">
                    <span>商品データ:</span>
                    <span id="inventoryStatus" class="status-badge status-normal">未アップロード</span>
                </div>
                <div class="status-item">
                    <span>在庫履歴集計:</span>
                    <span id="salesStatus" class="status-badge status-normal">未アップロード</span>
                </div>
            </div>
            <div class="current-settings">
                <h4>⚙️ 現在の設定</h4>
                <div style="font-size: 14px; color: #666; line-height: 1.4;">
                    <span id="currentSettings">分析期間: 2週間 | 発注点: 日平均出荷数 × 37日</span>
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                    <span id="lastCalculation">最終計算: 未実行</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="showSettings()">⚙️ 設定</button>
                <button class="btn btn-success" onclick="calculateReorderPoints()" id="calculateBtn" disabled>📊 発注点を計算</button>
                <button class="btn" onclick="downloadSampleCSV()">📥 スマレジCSV形式サンプル</button>
            </div>
        </div>

        <!-- サマリーカード -->
        <div class="summary-grid">
            <div class="summary-card alert">
                <div class="number" id="urgentCount">0</div>
                <div class="label">発注必要</div>
            </div>
            <div class="summary-card info">
                <div class="number" id="orderedCount">0</div>
                <div class="label">発注中</div>
            </div>
            <div class="summary-card warning">
                <div class="number" id="onHoldCount">0</div>
                <div class="label">発注停止中</div>
            </div>
            <div class="summary-card success">
                <div class="number" id="normalCount">0</div>
                <div class="label">在庫正常</div>
            </div>
        </div>

        <!-- データパネル -->
        <div class="data-panel">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('reorder')">🚨 発注必要</button>
                    <button class="tab-button" onclick="showTab('ordered')">📋 発注中</button>
                    <button class="tab-button" onclick="showTab('onhold')">⏸️ 発注停止中</button>
                    <button class="tab-button" onclick="showTab('all')">📊 全商品</button>
                    <button class="tab-copy-btn" onclick="copyAllCurrentTabCodes()" id="tabCopyBtn">全品番コピー</button>
                </div>
            </div>

            <div class="panel-header">
                <h3 class="panel-title" id="currentTabTitle">発注が必要な商品</h3>
                <div class="filter-controls">
                    <input type="text" class="search-box" placeholder="商品名で検索..." onkeyup="filterTable()">
                    <select onchange="filterByCategory()" id="categoryFilter">
                        <option value="">全カテゴリ</option>
                    </select>
                </div>
            </div>

            <!-- 発注必要タブ -->
            <div id="reorder-tab" class="tab-content active">
                <div class="table-controls">
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" id="selectAllReorder" onchange="toggleSelectAllReorder()">
                            全選択
                        </label>
                        <span class="selected-count" id="reorderSelectedCount">0件選択</span>
                    </div>
                    <div class="action-controls">
                        <button class="btn btn-success btn-sm" onclick="moveSelectedToOrdered()" id="moveToOrderedBtn" disabled>選択商品を発注中に移動</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">選択</th>
                            <th>商品名</th>
                            <th>カテゴリ</th>
                            <th>現在在庫</th>
                            <th>発注点</th>
                            <th>不足数</th>
                            <th>日平均販売</th>
                            <th>優先度</th>
                            <th class="action-column">個別操作</th>
                        </tr>
                    </thead>
                    <tbody id="reorderTableBody">
                        <tr>
                            <td colspan="9" class="loading">
                                <div class="loading-spinner"></div>
                                データを読み込んでいます...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 発注中タブ -->
            <div id="ordered-tab" class="tab-content">
                <div class="table-controls">
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" id="selectAllOrdered" onchange="toggleSelectAllOrdered()">
                            全選択
                        </label>
                        <span class="selected-count" id="orderedSelectedCount">0件選択</span>
                    </div>
                    <div class="action-controls">
                        <button class="btn btn-success btn-sm" onclick="completeSelectedOrders()" id="completeOrdersBtn" disabled>選択商品を入荷完了</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedOrders()" id="deleteOrdersBtn" disabled>選択商品を削除</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">選択</th>
                            <th>商品名</th>
                            <th>カテゴリ</th>
                            <th>現在在庫</th>
                            <th>発注数</th>
                            <th>発注日</th>
                            <th>予定納期</th>
                            <th>ステータス</th>
                            <th class="action-column">個別操作</th>
                        </tr>
                    </thead>
                    <tbody id="orderedTableBody">
                        <tr>
                            <td colspan="9" class="loading">発注中の商品はありません</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 発注停止中タブ -->
            <div id="onhold-tab" class="tab-content">
                <div class="table-controls">
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" id="selectAllOnHold" onchange="toggleSelectAllOnHold()">
                            全選択
                        </label>
                        <span class="selected-count" id="onHoldSelectedCount">0件選択</span>
                    </div>
                    <div class="action-controls">
                        <button class="btn btn-success btn-sm" onclick="resumeSelectedOrders()" id="resumeOrdersBtn" disabled>選択商品を発注再開</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedOnHold()" id="deleteOnHoldBtn" disabled>選択商品を削除</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">選択</th>
                            <th>商品名</th>
                            <th>カテゴリ</th>
                            <th>現在在庫</th>
                            <th>発注点</th>
                            <th>停止日</th>
                            <th>ステータス</th>
                            <th class="action-column">個別操作</th>
                        </tr>
                    </thead>
                    <tbody id="onHoldTableBody">
                        <tr>
                            <td colspan="8" class="loading">発注停止中の商品はありません</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 全商品タブ -->
            <div id="all-tab" class="tab-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>商品名</th>
                            <th>カテゴリ</th>
                            <th>現在在庫</th>
                            <th>発注点</th>
                            <th>日平均販売</th>
                            <th>ステータス</th>
                            <th class="action-column">操作</th>
                        </tr>
                    </thead>
                    <tbody id="allTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="loading-spinner"></div>
                                データを読み込んでいます...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 発注フォームモーダル -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2>📋 発注情報入力</h2>
            <div id="orderItemsList"></div>
            <div class="order-form">
                <div class="form-row">
                    <div class="form-group-inline">
                        <label for="orderQuantity">発注数</label>
                        <input type="number" id="orderQuantity" min="1" placeholder="発注数を入力">
                    </div>
                    <div class="form-group-inline">
                        <label for="expectedDelivery">予定納期</label>
                        <input type="date" id="expectedDelivery">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group-inline">
                        <label for="orderMemo">メモ</label>
                        <input type="text" id="orderMemo" placeholder="発注に関するメモ">
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn" onclick="closeOrderModal()">キャンセル</button>
                <button class="btn btn-success" onclick="confirmOrder()">発注確定</button>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h2>⚙️ システム設定</h2>
            
            <!-- 設定タブ -->
            <div class="settings-tab-container">
                <div class="settings-tab-buttons">
                    <button class="settings-tab-button active" onclick="showSettingsTab('calculation')">📊 計算設定</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('api')">📁 CSV設定</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('notification')">🔔 通知設定</button>
                    <button class="settings-tab-button" onclick="showSettingsTab('display')">🖥️ 表示設定</button>
                </div>
            </div>

            <!-- 計算設定タブ -->
            <div id="calculation-settings" class="settings-tab-content active">
                <h3>📊 発注点計算設定</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="analysisWeeks">分析期間</label>
                        <select id="analysisWeeks">
                            <option value="1">1週間</option>
                            <option value="2" selected>2週間</option>
                            <option value="3">3週間</option>
                            <option value="4">4週間</option>
                        </select>
                        <small>出荷データの分析期間を選択してください</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>発注点計算方法</label>
                        <div class="csv-format-info">
                            <p><strong>計算式:</strong></p>
                            <p>日平均出荷数 = 分析期間の出荷数 ÷ 分析日数</p>
                            <p>発注点 = 日平均出荷数 × 37日</p>
                            <p>発注判定 = 現在在庫 < 発注点</p>
                        </div>
                        <small>37日は固定値として使用されます</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="urgentThreshold">緊急発注しきい値</label>
                        <input type="number" id="urgentThreshold" value="50" min="0" max="100">
                        <small>発注点から何%下回ったら緊急とするか</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="autoCalculate">自動計算</label>
                        <select id="autoCalculate">
                            <option value="manual">手動のみ</option>
                            <option value="hourly">1時間ごと</option>
                            <option value="daily">1日1回</option>
                            <option value="weekly">週1回</option>
                        </select>
                        <small>発注点の自動再計算頻度</small>
                    </div>
                </div>
            </div>

            <!-- API設定タブ -->
            <div id="api-settings" class="settings-tab-content">
                <h3>📁 スマレジCSVファイル設定</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label>商品データCSVの形式</label>
                        <div class="csv-format-info">
                            <p><strong>ファイル名例:</strong> 商品データ20250707150911.csv</p>
                            <p><strong>使用する列:</strong></p>
                            <ul>
                                <li>C列: 商品コード (例: P001, 156&145)</li>
                                <li>D列: 部門名 (例: 自動車部品)</li>
                                <li>F列: 商品名 (例: P7 パーツフィルター50mm)</li>
                                <li>P列: 在庫数 (例: 5, 0)</li>
                            </ul>
                            <p><small>※スマレジ管理画面の「商品」→「商品一覧」からCSVエクスポート</small></p>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label>在庫履歴集計CSVの形式</label>
                        <div class="csv-format-info">
                            <p><strong>ファイル名例:</strong> 在庫履歴集計20250707153725.csv</p>
                            <p><strong>使用する列:</strong></p>
                            <ul>
                                <li>C列: 商品コード (例: P001, 156&145)</li>
                                <li>K列: 販売数量 (例: 5, 10)</li>
                            </ul>
                            <p><small>※スマレジ管理画面の「在庫」→「在庫履歴集計」からCSVエクスポート</small></p>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="csvEncoding">CSVエンコーディング</label>
                        <select id="csvEncoding">
                            <option value="shift_jis" selected>Shift-JIS (スマレジ標準)</option>
                            <option value="utf-8">UTF-8</option>
                            <option value="utf-8-bom">UTF-8 with BOM</option>
                        </select>
                        <small>スマレジのCSVは通常Shift-JISです</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="csvDelimiter">区切り文字</label>
                        <select id="csvDelimiter">
                            <option value="," selected>カンマ (,)</option>
                            <option value="\t">タブ</option>
                            <option value=";">セミコロン (;)</option>
                        </select>
                        <small>CSVファイルの区切り文字</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>データ検証</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="validateData" checked> データ整合性チェック</label>
                            <label><input type="checkbox" id="skipEmptyRows" checked> 空行をスキップ</label>
                            <label><input type="checkbox" id="autoCorrectData"> 自動データ修正</label>
                        </div>
                        <small>アップロード時のデータ検証オプション</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="googleScriptUrl">Google Apps Script URL</label>
                        <input type="url" id="googleScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <small>Google Apps ScriptのWebアプリURL</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>データ同期</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="syncFromSpreadsheet()">📥 スプレッドシートから取得</button>
                            <button class="btn" onclick="syncToSpreadsheet()">📤 スプレッドシートに保存</button>
                        </div>
                        <small>Googleスプレッドシートとのデータ同期</small>
                    </div>
                </div>
            </div>

            <!-- 通知設定タブ -->
            <div id="notification-settings" class="settings-tab-content">
                <h3>🔔 通知設定</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="emailNotification">メール通知</label>
                        <select id="emailNotification">
                            <option value="disabled">無効</option>
                            <option value="urgent">緊急時のみ</option>
                            <option value="daily">日次レポート</option>
                            <option value="weekly">週次レポート</option>
                        </select>
                        <small>メール通知の頻度を選択</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="emailAddress">通知先メールアドレス</label>
                        <input type="email" id="emailAddress" placeholder="notification@company.com">
                        <small>複数の場合はカンマで区切る</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="slackNotification">Slack通知</label>
                        <select id="slackNotification">
                            <option value="disabled">無効</option>
                            <option value="urgent">緊急時のみ</option>
                            <option value="all">全て</option>
                        </select>
                        <small>Slack通知の設定</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="slackWebhook">Slack Webhook URL</label>
                        <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                        <small>SlackのIncoming Webhook URL</small>
                    </div>
                </div>
            </div>

            <!-- 表示設定タブ -->
            <div id="display-settings" class="settings-tab-content">
                <h3>🖥️ 表示設定</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="itemsPerPage">1ページあたりの表示件数</label>
                        <select id="itemsPerPage">
                            <option value="10">10件</option>
                            <option value="25" selected>25件</option>
                            <option value="50">50件</option>
                            <option value="100">100件</option>
                        </select>
                        <small>テーブルの1ページに表示する商品数</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="theme">テーマ</label>
                        <select id="theme">
                            <option value="light" selected>ライト</option>
                            <option value="dark">ダーク</option>
                            <option value="auto">自動</option>
                        </select>
                        <small>画面の配色テーマ</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="refreshInterval">画面更新間隔</label>
                        <select id="refreshInterval">
                            <option value="manual">手動のみ</option>
                            <option value="300">5分</option>
                            <option value="900">15分</option>
                            <option value="1800">30分</option>
                            <option value="3600">1時間</option>
                        </select>
                        <small>データの自動更新間隔</small>
                    </div>
                    
                    <div class="setting-group">
                        <label for="compactMode">コンパクト表示</label>
                        <select id="compactMode">
                            <option value="false" selected>通常</option>
                            <option value="true">コンパクト</option>
                        </select>
                        <small>テーブルの行間を詰めて表示</small>
                    </div>
                </div>
            </div>

            <!-- 設定保存ボタン -->
            <div class="settings-footer">
                <button class="btn" onclick="resetSettings()">デフォルトに戻す</button>
                <button class="btn btn-success" onclick="saveSettings()">設定を保存</button>
            </div>
        </div>
    </div>

    <!-- コピー通知 -->
    <div id="copyNotification" class="copy-notification">
        コピーしました！
    </div>

    <script>
        // グローバル変数
        let inventoryData = [];
        let orderedItems = [];
        let onHoldItems = [];
        let currentTab = 'reorder';
        let uploadedInventoryData = null;
        let uploadedSalesData = null;
        let selectedReorderItems = new Set();
        let selectedOrderedItems = new Set();
        let selectedOnHoldItems = new Set();
        let itemsToOrder = [];
        let currentSettings = {
            analysisWeeks: 2,
            leadTime: 7,
            safetyStock: 3,
            urgentThreshold: 50,
            autoCalculate: 'manual',
            csvEncoding: 'shift_jis',
            csvDelimiter: ',',
            validateData: true,
            skipEmptyRows: true,
            autoCorrectData: false,
            googleScriptUrl: '',
            emailNotification: 'disabled',
            emailAddress: '',
            slackNotification: 'disabled',
            slackWebhook: '',
            itemsPerPage: 25,
            theme: 'light',
            refreshInterval: 'manual',
            compactMode: false
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadSampleData();
            updateLastUpdateTime();
            updateCurrentSettingsDisplay();
        });

        // サンプルデータ
        function loadSampleData() {
            inventoryData = [
                {
                    id: 'P001',
                    name: 'ノートPC Acer Aspire',
                    category: 'PC・周辺機器',
                    currentStock: 3,
                    totalSales: 28,
                    dailyAverage: 2.0,
                    reorderPoint: 74,
                    shortage: 71,
                    status: 'danger',
                    needsReorder: true,
                    leadTime: 7,
                    supplier: 'テックサプライ'
                },
                {
                    id: 'P002',
                    name: 'プリンタ用紙 A4 500枚',
                    category: 'オフィス用品',
                    currentStock: 5,
                    totalSales: 20,
                    dailyAverage: 1.4,
                    reorderPoint: 52,
                    shortage: 47,
                    status: 'danger',
                    needsReorder: true,
                    leadTime: 3,
                    supplier: 'オフィスマート'
                }
            ];

            orderedItems = [
                {
                    id: 'P006',
                    name: 'キーボード メカニカル',
                    category: 'PC・周辺機器',
                    currentStock: 1,
                    orderedQuantity: 20,
                    orderDate: '2025-07-01',
                    expectedDelivery: '2025-07-08',
                    status: 'ordered',
                    supplier: 'テックサプライ'
                }
            ];

            onHoldItems = [
                {
                    id: 'P007',
                    name: 'テスト商品（発注停止中）',
                    category: 'PC・周辺機器',
                    currentStock: 2,
                    reorderPoint: 15,
                    onHoldDate: '2025-07-05',
                    status: 'on-hold',
                    supplier: 'テストサプライ',
                    reason: '仕入先変更のため一時停止'
                }
            ];

            updateSummaryCards();
            updateTables();
            updateCategoryFilter();
        }

        // CSVファイル処理
        function handleInventoryFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        uploadedInventoryData = parseSmaregiInventoryCSV(csv);
                        
                        if (validateInventoryData(uploadedInventoryData)) {
                            document.getElementById('inventoryStatus').textContent = `✅ ${uploadedInventoryData.length}件読み込み`;
                            document.getElementById('inventoryStatus').className = 'status-badge status-uploaded';
                            checkCalculateButtonState();
                        } else {
                            throw new Error('データ形式が正しくありません');
                        }
                    } catch (error) {
                        document.getElementById('inventoryStatus').textContent = `❌ エラー: ${error.message}`;
                        document.getElementById('inventoryStatus').className = 'status-badge status-error';
                        uploadedInventoryData = null;
                    }
                };
                reader.readAsText(file, 'shift_jis');
            }
        }

        function handleSalesFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        uploadedSalesData = parseSmaregiSalesCSV(csv);
                        
                        if (validateSalesData(uploadedSalesData)) {
                            document.getElementById('salesStatus').textContent = `✅ ${uploadedSalesData.length}件読み込み`;
                            document.getElementById('salesStatus').className = 'status-badge status-uploaded';
                            checkCalculateButtonState();
                        } else {
                            throw new Error('データ形式が正しくありません');
                        }
                    } catch (error) {
                        document.getElementById('salesStatus').textContent = `❌ エラー: ${error.message}`;
                        document.getElementById('salesStatus').className = 'status-badge status-error';
                        uploadedSalesData = null;
                    }
                };
                reader.readAsText(file, 'shift_jis');
            }
        }

        // CSV解析関数
        function parseSmaregiInventoryCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && line.length > 0) {
                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 16) {
                        const productCode = columns[2] || '';
                        const department = columns[3] || '';
                        const productName = columns[5] || '';
                        const currentStock = parseInt(columns[15]) || 0;
                        
                        if (productCode && productName) {
                            data.push({
                                productId: productCode,
                                productName: productName,
                                category: department || '未分類',
                                currentStock: currentStock,
                                supplier: '未設定',
                                unitCost: 0
                            });
                        }
                    }
                }
            }
            return data;
        }

        function parseSmaregiSalesCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && line.length > 0) {
                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 11) {
                        const productCode = columns[2] || '';
                        const salesQuantity = parseInt(columns[10]) || 0;
                        
                        if (productCode && salesQuantity > 0) {
                            data.push({
                                productId: productCode,
                                saleDate: new Date().toISOString().split('T')[0],
                                quantity: salesQuantity,
                                unitPrice: 0
                            });
                        }
                    }
                }
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function validateInventoryData(data) {
            if (!data || data.length === 0) return false;
            const requiredFields = ['productId', 'productName', 'currentStock'];
            return data.every(row => 
                requiredFields.every(field => 
                    row[field] !== undefined && row[field] !== ''
                )
            );
        }

        function validateSalesData(data) {
            if (!data || data.length === 0) return false;
            const requiredFields = ['productId', 'quantity'];
            return data.every(row => 
                requiredFields.every(field => 
                    row[field] !== undefined && row[field] !== ''
                )
            );
        }

        function checkCalculateButtonState() {
            const button = document.getElementById('calculateBtn');
            if (uploadedInventoryData && uploadedSalesData) {
                button.disabled = false;
                button.textContent = '📊 発注点を計算';
            } else {
                button.disabled = true;
                button.textContent = '📊 CSVファイルをアップロード';
            }
        }

        function calculateFromCSV() {
            if (!uploadedInventoryData || !uploadedSalesData) {
                alert('商品データと在庫履歴集計データの両方をアップロードしてください。');
                return;
            }

            const analysisWeeks = currentSettings.analysisWeeks;
            const analysisDays = analysisWeeks * 7;
            const reorderCalculationDays = 37;

            const salesMap = new Map();
            uploadedSalesData.forEach(sale => {
                const productId = sale.productId;
                const quantity = parseInt(sale.quantity) || 0;
                if (salesMap.has(productId)) {
                    salesMap.set(productId, salesMap.get(productId) + quantity);
                } else {
                    salesMap.set(productId, quantity);
                }
            });

            const calculatedData = uploadedInventoryData.map(item => {
                const productId = item.productId;
                const currentStock = parseInt(item.currentStock) || 0;
                const totalSales = salesMap.get(productId) || 0;
                const dailyAverage = totalSales / analysisDays;
                const reorderPoint = Math.ceil(dailyAverage * reorderCalculationDays);
                const needsReorder = currentStock < reorderPoint;
                const shortage = Math.max(0, reorderPoint - currentStock);
                
                let status = 'normal';
                if (needsReorder) {
                    const shortageRatio = shortage / reorderPoint;
                    if (shortageRatio >= 0.5) {
                        status = 'danger';
                    } else {
                        status = 'warning';
                    }
                }

                return {
                    id: productId,
                    name: item.productName,
                    category: item.category || '未分類',
                    currentStock: currentStock,
                    totalSales: totalSales,
                    dailyAverage: Math.round(dailyAverage * 100) / 100,
                    reorderPoint: reorderPoint,
                    shortage: shortage,
                    status: status,
                    needsReorder: needsReorder,
                    leadTime: currentSettings.leadTime,
                    supplier: item.supplier || '未設定'
                };
            });

            inventoryData = calculatedData;
            
            updateSummaryCards();
            updateTables();
            updateCategoryFilter();
            updateLastUpdateTime();
            document.getElementById('lastCalculation').textContent = `最終計算: ${new Date().toLocaleString('ja-JP')}`;
            
            const reorderCount = calculatedData.filter(item => item.needsReorder).length;
            const dangerCount = calculatedData.filter(item => item.status === 'danger').length;
            const warningCount = calculatedData.filter(item => item.status === 'warning').length;
            
            alert(`発注点計算が完了しました！\n\n【計算式】\n日平均出荷数 = ${analysisWeeks}週間出荷数 ÷ ${analysisDays}日\n発注点 = 日平均出荷数 × 37日\n発注判定 = 在庫数 < 発注点\n\n【結果】\n処理件数: ${calculatedData.length}件\n発注必要: ${reorderCount}件\n　├ 緊急: ${dangerCount}件\n　└ 注意: ${warningCount}件`);
        }

        function calculateReorderPoints() {
            calculateFromCSV();
        }

        function refreshData() {
            alert('データを更新しています...');
            updateLastUpdateTime();
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `最終更新: ${timeString}`;
        }

        function updateSummaryCards() {
            const urgentCount = inventoryData.filter(item => item.needsReorder).length;
            const orderedCount = orderedItems.length;
            const onHoldCount = onHoldItems.length;
            const normalCount = inventoryData.filter(item => item.status === 'normal').length;

            document.getElementById('urgentCount').textContent = urgentCount;
            document.getElementById('orderedCount').textContent = orderedCount;
            document.getElementById('onHoldCount').textContent = onHoldCount;
            document.getElementById('normalCount').textContent = normalCount;
        }

        function updateTables() {
            updateReorderTable();
            updateOrderedTable();
            updateOnHoldTable();
            updateAllTable();
        }

        function updateReorderTable() {
            const tbody = document.getElementById('reorderTableBody');
            const reorderItems = inventoryData.filter(item => item.needsReorder);
            
            selectedReorderItems.clear();
            updateReorderSelection();
            
            if (reorderItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">発注が必要な商品はありません</td></tr>';
                return;
            }

            tbody.innerHTML = reorderItems.map(item => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="toggleReorderItemSelection('${item.id}')">
                    </td>
                    <td>
                        <div class="product-name-container">
                            <span class="product-code" onclick="copyToClipboard('${item.id}')" title="クリックでコピー">${item.id}</span>
                            <span class="product-name">${item.name}</span>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td><span class="number-${item.currentStock <= 5 ? 'negative' : 'neutral'}">${item.currentStock}</span></td>
                    <td>${item.reorderPoint}</td>
                    <td><span class="number-negative">${item.shortage}</span></td>
                    <td>${item.dailyAverage}</td>
                    <td><span class="status-badge status-${item.status}">${getPriorityText(item.status)}</span></td>
                    <td class="action-column">
                        <button class="btn btn-success btn-sm" onclick="markSingleAsOrdered('${item.id}')">発注</button>
                        <button class="btn btn-warning btn-sm" onclick="markAsOnHold('${item.id}')">停止</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateOrderedTable() {
            const tbody = document.getElementById('orderedTableBody');
            
            selectedOrderedItems.clear();
            updateOrderedSelection();
            
            if (orderedItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">発注中の商品はありません</td></tr>';
                return;
            }

            tbody.innerHTML = orderedItems.map(item => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="toggleOrderedItemSelection('${item.id}')">
                    </td>
                    <td>
                        <div class="product-name-container">
                            <span class="product-code" onclick="copyToClipboard('${item.id}')" title="
